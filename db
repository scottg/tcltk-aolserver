#!/bin/bash -e
#
# Copyright 2008 by Scott S. Goodwin

# We always want to be in top level directory
cd $(dirname $0)

source config.sh

if [ -z "$2" ]; then
	export SITENAME=default
else
	export SITENAME=$2
fi

if [ -d "$SITENAME" ]; then
	export SITEPATH=$SITENAME
elif [ -d "../$SITENAME" ]; then
	export SITEPATH="../$SITENAME"
else
	echo "Cannot find $SITENAME directory here or in ../$SITENAME"
	exit 1
fi

source $SITEPATH/config.sh

PGSTOP="$PGBIN/pg_ctl -w stop -D $PGDATA"
PGSTART="$PGBIN/pg_ctl -w start -D $PGDATA -l $SITEROOT/logs/postgres.log"

case $1 in
	start)
		if [ ! -f "$PGDATA/PG_VERSION" ] && [ "$1" != "init" ]; then
			echo "Initializing PGDATA area (only performed once)"
			echo ""
			$PGBIN/initdb -D $PGDATA --locale=C --encoding=UTF-8 -L $PGSHARE -A trust
		fi
		$PGSTART
		;;
	stop)
		$PGSTOP
		;;
	create)
		echo $PGDBNAME
		$PGBIN/createdb $PGDBNAME
		$PGBIN/createlang pltcl $PGDBNAME
		$PGBIN/createlang plpgsql $PGDBNAME
		;;
	drop)
		echo $PGDBNAME
		$PGBIN/dropdb $PGDBNAME
		;;
	destroy)
		$PGSTOP
		/bin/rm -r $PGDATA
		;;
	#dump)
	#	/bin/mkdir -p $ONEMIS/tmp/dbdump
	#	$PGBIN/pg_dump --format=p --disable-triggers --schema-only $PGDBNAME > $ONEMIS/tmp/dbdump/${PGDBNAME}.schema.sql
	#	$PGBIN/pg_dump --format=p --disable-triggers --data-only   $PGDBNAME > $ONEMIS/tmp/dbdump/${PGDBNAME}.data.sql
	#	$PGBIN/pg_dump --format=p --disable-triggers               $PGDBNAME > $ONEMIS/tmp/dbdump/${PGDBNAME}.complete.sql
	#	;;
	#load)
	#	$PGBIN/psql -f $ONEMIS/tmp/dbdump/${PGDBNAME}.complete.sql
	#	;;
	status)
		$PGBIN/pg_ctl status -D $PGDATA
		;;
	hup)
		$PGBIN/pg_ctl reload -D $PGDATA
		;;
	#get)
	#	# XXX FIX AFTER WE'VE MOVED TO OPERATIONS - paths are wrong for new way, but work with old
	#	###rsync -atv --rsh="ssh -p 8443 -l onemis" --delete onemis.nasa.gov:/home/onemis/sql/DB/dump /home/onemis/sql/DB
	#	;;
	*)
		echo "$0: unknown subcommand: $@"
		;;
esac

